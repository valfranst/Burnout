<div class="container section">
  <div style="max-width:640px; margin:0 auto;">
    <h1 class="section-title">Registrar meu dia</h1>
    <p class="text-muted mb-2">Preencha as métricas do seu dia para receber a análise de burnout.</p>
    <div id="alert-box"></div>

    <!-- Result card (hidden initially) -->
    <div id="result" class="card hidden mb-2" style="border-left:4px solid var(--primary);">
      <h3>Resultado da Análise</h3>
      <div class="stats-grid" style="margin-top:1rem;">
        <div class="stat-card"><div class="stat-value" id="r-score">—</div><div class="stat-label">Score</div></div>
        <div class="stat-card"><div class="stat-value" id="r-risk">—</div><div class="stat-label">Risco</div></div>
        <div class="stat-card"><div class="stat-value" id="r-arch">—</div><div class="stat-label">Arquétipo</div></div>
      </div>
    </div>

    <form id="log-form" class="card">
      <div class="form-row">
        <div class="form-group">
          <label for="data_registro">Data</label>
          <input type="date" id="data_registro" name="data_registro">
        </div>
        <div class="form-group">
          <label for="day_type">Tipo de Dia</label>
          <select id="day_type" name="day_type" disabled>
            <option value="Weekday">Dia útil</option>
            <option value="Weekend">Final de semana</option>
          </select>
        </div>
      </div>

      <h3 style="margin:1rem 0 .5rem; font-size:.95rem;">Métricas Comportamentais</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="work_hours">Horas de Trabalho</label>
          <input type="number" id="work_hours" name="work_hours" min="0.5" max="18" step="0.5" required placeholder="Ex: 8">
        </div>
        <div class="form-group">
          <label for="screen_time_hours">Tempo de Tela (h)</label>
          <input type="number" id="screen_time_hours" name="screen_time_hours" min="0" max="18" step="0.5" required placeholder="Ex: 10">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="meetings_count">Reuniões</label>
          <input type="number" id="meetings_count" name="meetings_count" min="0" max="30" required placeholder="Ex: 4">
        </div>
        <div class="form-group">
          <label for="app_switches">Troca de Apps</label>
          <input type="number" id="app_switches" name="app_switches" min="0" max="500" required placeholder="Ex: 50">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="breaks_taken">Pausas no Dia</label>
          <input type="number" id="breaks_taken" name="breaks_taken" min="0" max="20" required placeholder="Ex: 3">
        </div>
        <div class="form-group">
          <label for="after_hours_work">Trabalhou Após Expediente?</label>
          <select id="after_hours_work" name="after_hours_work">
            <option value="false">Não</option>
            <option value="true">Sim</option>
          </select>
        </div>
      </div>

      <h3 style="margin:1rem 0 .5rem; font-size:.95rem;">Métricas Psicológicas</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="sleep_hours">Horas de Sono</label>
          <input type="number" id="sleep_hours" name="sleep_hours" min="0" max="12" step="0.5" required placeholder="Ex: 7">
        </div>
        <div class="form-group">
          <label for="fatigue_score">Fadiga (0-10)</label>
          <input type="number" id="fatigue_score" name="fatigue_score" min="0" max="10" step="0.5" required placeholder="Ex: 6">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="isolation_index">Índice de Isolamento (3-9)
            <button type="button" class="info-icon" id="isolation-info-btn" aria-label="Como preencher o índice de isolamento">i</button>
          </label>
          <input type="number" id="isolation_index" name="isolation_index" min="3" max="9" step="1" required placeholder="Ex: 5">
        </div>
        <div class="form-group">
          <label for="task_completion">Conclusão de Tarefas (%)</label>
          <input type="number" id="task_completion" name="task_completion" min="0" max="100" value="80" placeholder="Ex: 80">
        </div>
      </div>

      <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:1rem;">
        Enviar e Analisar
      </button>
    </form>
  </div>
</div>

<div id="isolation-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="iso-modal-title">
  <div id="isolation-modal-overlay" class="modal-overlay"></div>
  <div class="modal-dialog">
    <h3 id="iso-modal-title">Índice de Isolamento</h3>
    <p>Use 3 (baixo isolamento) até 9 (alto isolamento). Esta faixa segue a lógica da UCLA Loneliness Scale: valores maiores indicam mais sensação de solidão ou desconexão. Procure registrar como se sentiu na média do dia.</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-outline" id="iso-modal-close">Entendi</button>
    </div>
  </div>
</div>

<script>
  // Default date to today and auto-fill day type
  const dateField = document.getElementById('data_registro');
  const dayTypeField = document.getElementById('day_type');
  const isolationField = document.getElementById('isolation_index');
  const isolationInfoBtn = document.getElementById('isolation-info-btn');
  const isolationModal = document.getElementById('isolation-modal');
  const isolationOverlay = document.getElementById('isolation-modal-overlay');
  const isoModalClose = document.getElementById('iso-modal-close');

  const updateDayType = () => {
    const chosen = new Date(dateField.value);
    if (Number.isNaN(chosen)) { dayTypeField.value = 'Weekday'; return; }
    const isWeekend = [0, 6].includes(chosen.getDay());
    dayTypeField.value = isWeekend ? 'Weekend' : 'Weekday';
  };

  dateField.valueAsDate = new Date();
  updateDayType();
  dateField.addEventListener('change', updateDayType);

  isolationField.addEventListener('input', () => {
    const val = Number(isolationField.value);
    if (Number.isNaN(val)) return;
    isolationField.value = Math.min(9, Math.max(3, val));
  });

  const closeIsolationModal = () => isolationModal.classList.add('hidden');
  if (isolationInfoBtn && isolationModal) isolationInfoBtn.addEventListener('click', () => isolationModal.classList.remove('hidden'));
  if (isolationOverlay) isolationOverlay.addEventListener('click', closeIsolationModal);
  if (isoModalClose) isoModalClose.addEventListener('click', closeIsolationModal);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isolationModal && !isolationModal.classList.contains('hidden')) closeIsolationModal();
  });

  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const box = document.getElementById('alert-box');
    App.hideAlert(box);

    const isoVal = parseInt(form.isolation_index.value);
    if (Number.isNaN(isoVal) || isoVal < 3 || isoVal > 9) {
      App.showAlert(box, 'Índice de isolamento deve estar entre 3 e 9.');
      return;
    }

    const payload = {
      data_registro: form.data_registro.value,
      day_type: form.day_type.value,
      work_hours: parseFloat(form.work_hours.value),
      screen_time_hours: parseFloat(form.screen_time_hours.value),
      meetings_count: parseInt(form.meetings_count.value),
      app_switches: parseInt(form.app_switches.value),
      breaks_taken: parseInt(form.breaks_taken.value),
      after_hours_work: form.after_hours_work.value === 'true',
      sleep_hours: parseFloat(form.sleep_hours.value),
      fatigue_score: parseFloat(form.fatigue_score.value),
      isolation_index: isoVal,
      task_completion: parseInt(form.task_completion.value),
    };

    try {
      const res = await App.api('/burnout-logs', { method: 'POST', body: JSON.stringify(payload) });
      document.getElementById('r-score').textContent = res.burnoutScore;
      document.getElementById('r-risk').innerHTML = `<span class="badge badge-${res.burnoutRisk.toLowerCase()}">${res.burnoutRisk}</span>`;
      document.getElementById('r-arch').textContent = res.archetype;
      document.getElementById('result').classList.remove('hidden');
      App.showAlert(box, 'Registro salvo com sucesso!', 'success');
    } catch (err) {
      if (err.status === 401) { window.location.href = '/login.html'; return; }
      App.showAlert(box, err.error || 'Erro ao enviar registro.');
    }
  });
</script>
