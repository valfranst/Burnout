<div class="container section">
  <h1 class="section-title">Relatório Público</h1>
  <p class="text-muted mb-2">Dados agregados e anônimos de todos os participantes.</p>
  <div id="alert-box"></div>
  <div id="loading" class="text-center text-muted" style="padding:3rem;">
    <span class="loading-dot">●</span> Carregando dados...
  </div>

  <div id="overall" class="stats-grid hidden"></div>

  <div class="charts-row hidden" id="charts-row-top">
    <div class="card fade-in-up">
      <h3 class="section-title-accent">Distribuição de Risco</h3>
      <div class="chart-container chart-sm">
        <canvas id="chart-risk"></canvas>
      </div>
    </div>
    <div class="card fade-in-up" style="animation-delay:.1s">
      <h3 class="section-title-accent">Burnout por Dia da Semana</h3>
      <div class="chart-container chart-sm">
        <canvas id="chart-dow"></canvas>
      </div>
    </div>
  </div>

  <div id="trend-section" class="card hidden mb-2 fade-in-up" style="animation-delay:.2s">
    <h3 class="section-title-accent">Tendência — Últimos 30 Dias</h3>
    <div class="chart-container">
      <canvas id="chart-trend"></canvas>
    </div>
  </div>

  <div id="arch-section" class="card hidden mb-2 fade-in-up" style="animation-delay:.3s">
    <h3 class="section-title-accent">Arquétipos Comportamentais</h3>
    <div class="chart-container chart-sm">
      <canvas id="chart-arch"></canvas>
    </div>
  </div>
</div>

<script>
  let chartRisk = null;
  let chartDow = null;
  let chartTrend = null;
  let chartArch = null;

  async function loadReport() {
    const box = document.getElementById('alert-box');
    try {
      const data = await App.api('/report');
      document.getElementById('loading').classList.add('hidden');

      const o = data.overall;
      const overallEl = document.getElementById('overall');
      overallEl.innerHTML = `
        <div class="card stat-card">
          <div class="stat-value" id="o-users">0</div>
          <div class="stat-label">Usuários</div>
        </div>
        <div class="card stat-card">
          <div class="stat-value" id="o-records">0</div>
          <div class="stat-label">Registros</div>
        </div>
        <div class="card stat-card">
          <div class="stat-value" id="o-avg">${o.avg_burnout_score ?? '—'}</div>
          <div class="stat-label">Score Médio</div>
        </div>
        <div class="card stat-card">
          <div class="stat-value" id="o-fatigue">${o.avg_fatigue_score ?? '—'}</div>
          <div class="stat-label">Fadiga Média</div>
        </div>`;
      overallEl.classList.remove('hidden');

      Charts.animateCounter(document.getElementById('o-users'), o.total_users ?? 0);
      Charts.animateCounter(document.getElementById('o-records'), o.total_records ?? 0);

      const chartsRowTop = document.getElementById('charts-row-top');

      // Risk distribution doughnut
      if (data.riskDistribution?.length) {
        chartsRowTop.classList.remove('hidden');
        chartRisk = Charts.destroy(chartRisk);
        chartRisk = Charts.doughnut(
          document.getElementById('chart-risk'),
          data.riskDistribution.map(riskItem => `${riskItem.burnout_risk} (${riskItem.percentage}%)`),
          data.riskDistribution.map(riskItem => Number(riskItem.total)),
          [Charts.COLORS.success, Charts.COLORS.warning, Charts.COLORS.danger]
        );
      }

      // Day of week bar
      if (data.burnoutByDayOfWeek?.length) {
        chartsRowTop.classList.remove('hidden');
        chartDow = Charts.destroy(chartDow);
        chartDow = Charts.bar(
          document.getElementById('chart-dow'),
          data.burnoutByDayOfWeek.map(day => day.day_of_week.trim()),
          data.burnoutByDayOfWeek.map(day => Number(day.avg_burnout_score)),
          'Score Médio',
          Charts.COLORS.info
        );
      }

      // 30-day trend line
      if (data.trend30Days?.length) {
        chartTrend = Charts.destroy(chartTrend);
        chartTrend = Charts.line(
          document.getElementById('chart-trend'),
          data.trend30Days.map(t => t.data_registro || t.created_at),
          [{ label: 'Score Médio', data: data.trend30Days.map(t => Number(t.avg_burnout_score)), borderColor: Charts.COLORS.primary }]
        );
        document.getElementById('trend-section').classList.remove('hidden');
      }

      // Archetype distribution bar
      if (data.archetypeDistribution?.length) {
        chartArch = Charts.destroy(chartArch);
        chartArch = Charts.bar(
          document.getElementById('chart-arch'),
          data.archetypeDistribution.map(a => a.archetype),
          data.archetypeDistribution.map(a => Number(a.total)),
          null,
          Charts.PALETTE
        );
        document.getElementById('arch-section').classList.remove('hidden');
      }

    } catch (err) {
      document.getElementById('loading').classList.add('hidden');
      App.showAlert(box, err.error || 'Erro ao carregar relatório.');
    }
  }
  loadReport();
</script>
