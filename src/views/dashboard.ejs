<div class="container section">
  <h1 class="section-title">Meu Dashboard</h1>
  <div id="alert-box"></div>
  <div id="loading" class="text-center text-muted" style="padding:3rem;">
    <span class="loading-dot">‚óè</span> Carregando dados...
  </div>

  <div id="summary" class="stats-grid hidden"></div>

  <div class="charts-row hidden" id="charts-row">
    <div class="card fade-in-up">
      <h3 class="section-title-accent">Distribui√ß√£o de Risco</h3>
      <div class="chart-container chart-sm">
        <canvas id="chart-risk"></canvas>
      </div>
    </div>
    <div class="card fade-in-up" style="animation-delay:.1s">
      <h3 class="section-title-accent">Tend√™ncia Temporal</h3>
      <p id="t-trend" class="text-muted" style="font-size:.82rem; margin-bottom:.25rem;"></p>
      <div class="chart-container chart-sm">
        <canvas id="chart-trend"></canvas>
      </div>
    </div>
  </div>

  <div id="anomalies-section" class="card hidden mb-2 fade-in-up" style="animation-delay:.2s">
    <h3 class="section-title-accent">Anomalias Detectadas</h3>
    <div class="chart-container chart-sm">
      <canvas id="chart-anomalies"></canvas>
    </div>
  </div>

  <div id="interv-section" class="card hidden mb-2 fade-in-up" style="animation-delay:.25s">
    <h3 class="section-title-accent">Efic√°cia de Pausas</h3>
    <p id="i-text" class="text-muted"></p>
  </div>

  <div id="records-section" class="card hidden mb-2 fade-in-up" style="animation-delay:.3s">
    <h3 class="section-title-accent">√öltimos Registros</h3>
    <div class="table-wrapper">
      <table id="r-table">
        <thead><tr><th>Data</th><th>Score</th><th>Risco</th><th>Arqu√©tipo</th><th>Fadiga</th><th>Horas Trab.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const riskBadge = (r) => `<span class="badge badge-${r.toLowerCase()}">${r}</span>`;

  let chartRisk = null;
  let chartTrend = null;
  let chartAnomalies = null;

  async function loadDashboard() {
    const box = document.getElementById('alert-box');
    try {
      const data = await App.api('/dashboard');
      document.getElementById('loading').classList.add('hidden');

      const s = data.summary;

      // Animated stat cards
      const riskEntries = Object.entries(s.riskDistribution).sort((a, b) => b[1] - a[1]);
      const dominant = riskEntries[0];
      const summaryEl = document.getElementById('summary');
      summaryEl.innerHTML = `
        <div class="card stat-card">
          <div class="stat-value" id="s-total">0</div>
          <div class="stat-label">Registros (90d)</div>
        </div>
        <div class="card stat-card">
          <div class="stat-value" id="s-avg">‚Äî</div>
          <div class="stat-label">Score M√©dio</div>
        </div>
        <div class="card stat-card">
          <div class="stat-value" id="s-risk">${dominant ? riskBadge(dominant[0]) : '‚Äî'}</div>
          <div class="stat-label">Risco Dominante</div>
        </div>
        <div class="card stat-card">
          <div class="stat-value" id="s-arch">${s.dominantArchetype || '‚Äî'}</div>
          <div class="stat-label">Arqu√©tipo</div>
        </div>`;
      summaryEl.classList.remove('hidden');

      Charts.animateCounter(document.getElementById('s-total'), s.totalRecords);
      document.getElementById('s-avg').textContent = s.avgBurnoutScore ?? '‚Äî';

      // Risk distribution doughnut chart
      if (riskEntries.length) {
        const chartsRow = document.getElementById('charts-row');
        chartsRow.classList.remove('hidden');
        chartRisk = Charts.destroy(chartRisk);
        chartRisk = Charts.doughnut(
          document.getElementById('chart-risk'),
          riskEntries.map(([k]) => k),
          riskEntries.map(([, v]) => v),
          [Charts.COLORS.success, Charts.COLORS.warning, Charts.COLORS.danger]
        );
      }

      // Temporal trend line chart
      if (data.temporal && data.temporal.weeklyAverages.length) {
        const trendMap = { improving: 'üìâ Melhorando', stable: '‚û°Ô∏è Est√°vel', worsening: 'üìà Piorando' };
        document.getElementById('t-trend').textContent =
          `Tend√™ncia: ${trendMap[data.temporal.trend] || data.temporal.trend} (delta: ${data.temporal.delta})`;
        chartTrend = Charts.destroy(chartTrend);
        chartTrend = Charts.line(
          document.getElementById('chart-trend'),
          data.temporal.weeklyAverages.map(w => w.week),
          [{ label: 'Score M√©dio', data: data.temporal.weeklyAverages.map(w => w.avg), borderColor: Charts.COLORS.primary }]
        );
        document.getElementById('charts-row').classList.remove('hidden');
      }

      // Anomalies bar chart
      if (data.anomalies && data.anomalies.length) {
        const sec = document.getElementById('anomalies-section');
        chartAnomalies = Charts.destroy(chartAnomalies);
        chartAnomalies = Charts.bar(
          document.getElementById('chart-anomalies'),
          data.anomalies.map(anomaly => (anomaly.created_at || '').slice(0, 10)),
          data.anomalies.map(anomaly => anomaly.fatigue_score),
          'Fadiga',
          Charts.COLORS.danger
        );
        sec.classList.remove('hidden');
      }

      if (data.interventions) {
        const i = data.interventions;
        document.getElementById('i-text').textContent =
          `Score m√©dio ap√≥s dia com muitas pausas: ${i.avgScoreAfterHighBreakDay} | ` +
          `Ap√≥s poucas pausas: ${i.avgScoreAfterLowBreakDay} | ` +
          `Efeito: ${i.interventionEffect} ‚Äî ${i.effective ? '‚úÖ Pausas ajudam' : '‚ö†Ô∏è Sem efeito claro'}`;
        document.getElementById('interv-section').classList.remove('hidden');
      }

      if (data.latestRecords?.length) {
        const tbody = document.querySelector('#r-table tbody');
        data.latestRecords.forEach(r => {
          tbody.innerHTML += `<tr>
            <td>${(r.created_at || '').slice(0, 10)}</td>
            <td>${r.burnout_score}</td>
            <td>${riskBadge(r.burnout_risk)}</td>
            <td>${r.archetype || '‚Äî'}</td>
            <td>${r.fatigue_score ?? '‚Äî'}</td>
            <td>${r.work_hours ?? '‚Äî'}</td>
          </tr>`;
        });
        document.getElementById('records-section').classList.remove('hidden');
      }

    } catch (err) {
      document.getElementById('loading').classList.add('hidden');
      if (err.status === 401) {
        window.location.href = '/login';
        return;
      }
      App.showAlert(box, err.error || 'Erro ao carregar dashboard.');
    }
  }

  loadDashboard();
</script>
